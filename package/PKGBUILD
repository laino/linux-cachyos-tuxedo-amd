# Minimal PKGBUILD generated by scripts/generate_packages.py
pkgbase=linux-cachyos-tuxedo-amd
pkgname=("${pkgbase}" "${pkgbase}-headers")
pkgver=6.19.0rc5
pkgrel=1
arch=('x86_64')
_srcname=linux-amd-drm-fixes-6.19-2026-01-15
pkgdesc="TUXEDO kernel based on CachyOS defaults"
license=('GPL-2.0-only')
url="https://github.com/laino/tuxedo-cachyos-kernel"
options=('!strip' '!debug' '!lto')
makedepends=(bc cpio gettext libelf pahole perl python rust rust-bindgen rust-src tar xz zstd clang llvm lld)
BUILD_FLAGS=(CC=clang LD=ld.lld LLVM=1 LLVM_IAS=1)
source=(
    "https://gitlab.freedesktop.org/agd5f/linux/-/archive/amd-drm-fixes-6.19-2026-01-15/linux-amd-drm-fixes-6.19-2026-01-15.tar.gz"
    "config"
    "patches.tar.gz"
)
sha256sums=(
    'SKIP'
    'SKIP'
    'SKIP'
)

prepare() {
    # Kernel sources
    cd "${_srcname}"
    [ -f ../patches.tar.gz ] && tar xf ../patches.tar.gz -C ..
    for p in ../*.patch; do
        echo "Applying patch $p"
        patch -Np1 -N < "$p"
    done

    [ -f ../config ] && cp ../config .config
     
    echo "-$pkgrel" > localversion.10-pkgrel
    echo "tuxedo" > localversion.20-pkgname

    # align with CachyOS defaults (BORE)
    scripts/config -d GENERIC_CPU -d X86_NATIVE_CPU -e MZEN4
    scripts/config -e CACHY
    scripts/config -e SCHED_BORE
    scripts/config -e LTO_CLANG_THIN
    scripts/config -d AUTOFDO_CLANG
    scripts/config -d CFI -d CFI_CLANG -d CFI_PERMISSIVE
    scripts/config -d RUST -d X86_X32
    scripts/config --set-str CC_IMPLICIT_FALLTHROUGH "-Wimplicit-fallthrough"

    # tick rate, preempt, tickless, hugepages, USER_NS, O3
    scripts/config -d HZ_300 -e HZ_1000 --set-val HZ 1000
    scripts/config -e PREEMPT_DYNAMIC -e PREEMPT -d PREEMPT_VOLUNTARY -d PREEMPT_LAZY -d PREEMPT_NONE
    scripts/config -d HZ_PERIODIC -d NO_HZ_IDLE -d CONTEXT_TRACKING_FORCE -e NO_HZ_FULL_NODEF -e NO_HZ_FULL -e NO_HZ -e NO_HZ_COMMON -e CONTEXT_TRACKING
    scripts/config -d TRANSPARENT_HUGEPAGE_MADVISE -e TRANSPARENT_HUGEPAGE_ALWAYS
    scripts/config -d CC_OPTIMIZE_FOR_PERFORMANCE -e CC_OPTIMIZE_FOR_PERFORMANCE_O3
    scripts/config -e USER_NS

    make "${BUILD_FLAGS[@]}" prepare
    yes "" | make "${BUILD_FLAGS[@]}" config >/dev/null

    make -s kernelrelease > version
}

build() {
    cd "${_srcname}"
    make "${BUILD_FLAGS[@]}" -j"$(nproc)" all
    make -C tools/bpf/bpftool vmlinux.h feature-clang-bpf-co-re=1
}

_package() {
    cd "${_srcname}"
    local modulesdir="${pkgdir}/usr/lib/modules/$(<version)"
    install -Dm644 "$(make -s image_name)" "${modulesdir}/vmlinuz"
    echo "${pkgname}" | install -Dm644 /dev/stdin "${modulesdir}/pkgbase"
    ZSTD_CLEVEL=19 make "${BUILD_FLAGS[@]}" INSTALL_MOD_PATH="${pkgdir}/usr" INSTALL_MOD_STRIP=1 DEPMOD=/doesnt/exist modules_install
    rm "${modulesdir}/build"
}

_package_headers() {
    cd "${_srcname}"
    local builddir="${pkgdir}/usr/lib/modules/$(<version)/build"

    mkdir -p "${builddir}"

    echo "Installing core build artifacts..."
    install -Dm644 .config Module.symvers System.map Makefile "${builddir}/"
    install -Dm644 vmlinux "${builddir}/vmlinux"
    install -Dm644 localversion.* version "${builddir}/"

    echo "Installing headers..."
    make "${BUILD_FLAGS[@]}" INSTALL_HDR_PATH="${builddir}/usr" headers_install

    mkdir -p "${builddir}/arch/x86/kernel"
    install -Dm644 kernel/Makefile "${builddir}/kernel/Makefile"
    install -Dm644 arch/x86/Makefile "${builddir}/arch/x86/Makefile"
    install -Dm644 arch/x86/kernel/asm-offsets.s "${builddir}/arch/x86/kernel/asm-offsets.s"
    cp -a scripts "${builddir}/"
    cp -a include "${builddir}/"
    mkdir -p "${builddir}/arch/x86"
    cp -a arch/x86/include "${builddir}/arch/x86/"
    ln -srt "${builddir}" "${builddir}/scripts/gdb/vmlinux-gdb.py"

    echo "Installing extra subsystem headers..."
    install -Dt "${builddir}/drivers/md" -m644 drivers/md/*.h
    install -Dt "${builddir}/net/mac80211" -m644 net/mac80211/*.h
    install -Dt "${builddir}/drivers/media/i2c" -m644 drivers/media/i2c/msp3400-driver.h
    install -Dt "${builddir}/drivers/media/usb/dvb-usb" -m644 drivers/media/usb/dvb-usb/*.h
    install -Dt "${builddir}/drivers/media/dvb-frontends" -m644 drivers/media/dvb-frontends/*.h
    install -Dt "${builddir}/drivers/media/tuners" -m644 drivers/media/tuners/*.h
    install -Dt "${builddir}/drivers/iio/common/hid-sensors" -m644 drivers/iio/common/hid-sensors/*.h

    echo "Installing Kconfig files..."
    find . -name 'Kconfig*' -exec install -Dm644 {} "${builddir}/{}" \;

    echo "Installing tooling..."
    if [ -x tools/objtool/objtool ]; then
        install -Dt "${builddir}/tools/objtool" tools/objtool/objtool
    fi
    if [ -x tools/bpf/resolve_btfids/resolve_btfids ]; then
        install -Dt "${builddir}/tools/bpf/resolve_btfids" tools/bpf/resolve_btfids/resolve_btfids
    fi
    if [ -f tools/bpf/bpftool/vmlinux.h ]; then
        install -Dt "${builddir}/tools/bpf/bpftool" -m644 tools/bpf/bpftool/vmlinux.h
    fi
    if compgen -G "rust/*.rmeta" 1>/dev/null; then
        install -Dt "${builddir}/rust" -m644 rust/*.rmeta
    fi
    if compgen -G "rust/*.so" 1>/dev/null; then
        install -Dt "${builddir}/rust" rust/*.so
    fi

    echo "Installing VDSO..."
    make INSTALL_MOD_PATH="${pkgdir}/usr" vdso_install link=

    echo "Removing unneeded architectures..."
    for arch in "${builddir}"/arch/*/; do
        [[ $arch = */x86/ ]] && continue
        rm -r "$arch"
    done

    echo "Pruning documentation..."
    rm -rf "${builddir}/Documentation"

    echo "Removing broken symlinks and loose objects..."
    find -L "${builddir}" -type l -delete
    find "${builddir}" -type f -name '*.o' -delete

    echo "Stripping build tools..."
    while IFS= read -r -d '' f; do
        strip --strip-unneeded "$f" 2>/dev/null || true
    done < <(find "${builddir}" -type f -perm -u+x ! -name vmlinux -print0)

    echo "Stripping vmlinux..."
    strip --strip-debug "${builddir}/vmlinux" 2>/dev/null || true

    echo "Adding /usr/src symlink..."
    mkdir -p "${pkgdir}/usr/src"
    ln -sr "${builddir}" "${pkgdir}/usr/src/${pkgbase}"
}

for _p in "${pkgname[@]}"; do
    _suffix=${_p#$pkgbase}
    case "${_suffix}" in
        "") _impl=_package ;;
        "-headers") _impl=_package_headers ;;
        *) continue ;;
    esac
    eval "package_${_p}() { ${_impl}; }"
done
